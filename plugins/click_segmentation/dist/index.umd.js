(function(r,p){typeof exports=="object"&&typeof module<"u"?p(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("@fiftyone/state"),require("recoil"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","@fiftyone/state","recoil","react"],p):(r=typeof globalThis<"u"?globalThis:r||self,p(r.__fop__,r.__foo__,r.__fos__,r.recoil,r.React))})(this,function(r,p,F,O,o){"use strict";function N(t){const a=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const c in t)if(c!=="default"){const l=Object.getOwnPropertyDescriptor(t,c);Object.defineProperty(a,c,l.get?l:{enumerable:!0,get:()=>t[c]})}}return a.default=t,Object.freeze(a)}const B=N(F);function P(){var w,z;const t=O.useRecoilValue(B.modalSample),[a,c]=o.useState([]),[l,A]=o.useState(!1),[n,D]=o.useState(!1),[d,f]=o.useState(!1),[m,X]=o.useState("user_clicks"),[v,Y]=o.useState(""),[h,T]=o.useState("segment-anything-2-hiera-tiny-image-torch"),[b,j]=o.useState("label");o.useEffect(()=>{c([])},[(w=t==null?void 0:t.sample)==null?void 0:w._id]),o.useEffect(()=>{if(!t)return;const e=t.sample.metadata;(!e||!e.width||!e.height)&&(console.log("Sample metadata not available. Computing metadata"),p.executeOperator("@51labs/click_segmentation/compute_metadata",{}).catch(i=>{console.error("Failed to compute metadata:",i)}))},[(z=t==null?void 0:t.sample)==null?void 0:z._id]),o.useEffect(()=>{if(!l||!t)return;const e=async i=>{const g=i.target;if(g.tagName!=="CANVAS"||d)return;const s=g.getBoundingClientRect(),u=t.sample.metadata;if(!u||!u.width||!u.height){alert("Sample metadata not yet available. Reload/refresh the sample modal.");return}const k=u.width/u.height,L=s.width/s.height;let x,y,R,S;k>L?(x=s.width,y=s.width/k,R=0,S=(s.height-y)/2):(y=s.height,x=s.height*k,R=(s.width-x)/2,S=0);const M=i.clientX-s.left,V=i.clientY-s.top,_=M-R,C=V-S;if(_<0||_>x||C<0||C>y){console.log("Click outside image bounds");return}const H=_/x,G=C/y,E={normalizedX:parseFloat(H.toFixed(4)),normalizedY:parseFloat(G.toFixed(4))};console.log("Click captured:",E),n?await I(E):c(J=>[...J,E])};return document.addEventListener("click",e,!0),()=>document.removeEventListener("click",e,!0)},[l,t,n,d,h,m]);const q=async()=>{if(f(!0),!m.trim()){alert("Please enter a field name");return}const e=a.map(i=>[i.normalizedX,i.normalizedY]);try{await p.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:e,kpts_field_name:m.trim(),label_name:b.trim()}),c([])}catch(i){console.error("Error saving keypoints:",i),alert(`Failed: ${i.message}`)}finally{n||f(!1)}},I=async e=>{f(!0);const i=[[e.normalizedX,e.normalizedY]];try{console.log("Auto segmenting with ",e),await p.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:i,kpts_field_name:m.trim(),label_name:b.trim()}),await new Promise(g=>setTimeout(g,10)),await p.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:m.trim(),model_name:h.trim(),label_field:v.trim()}),c([])}catch(g){console.error("Error auto segmenting:",g),alert(`Failed: ${g.message}`)}finally{f(!1)}},K=async()=>{f(!0);try{await p.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:m.trim(),model_name:h.trim(),label_field:v.trim()})}catch(e){console.error("Error saving keypoints:",e),alert(`Failed: ${e.message}`)}finally{f(!1)}},$=()=>{c([])};return React.createElement("div",{style:{padding:"20px",display:"flex",flexDirection:"column",height:"100%"}},React.createElement("div",{style:{marginBottom:"10px"}},React.createElement("h3",{style:{margin:0}},"Image segmentation via point prompts")),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:l?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${l?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:l,onChange:e=>A(e.target.checked),style:{width:"20px",height:"20px",cursor:"pointer"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:l?"#1976d2":"#666"}},l?"Capturing Clicks":"Activate Click Capture")),l&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Click anywhere on the modal image to capture keypoints.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving clicks (as keypoints)"),React.createElement("input",{type:"text",value:m,onChange:e=>X(e.target.value),placeholder:"e.g., user_clicks, keypoints",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving segmentation masks"),React.createElement("input",{type:"text",value:"",onChange:e=>Y(e.target.value),placeholder:"Set to {keypoint_field}_seg if no input provided",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Label name for the current set of clicks"),React.createElement("input",{type:"text",value:b,onChange:e=>j(e.target.value),placeholder:"e.g., animal, person",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:n?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${n?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:n,onChange:e=>D(e.target.checked),style:{width:"20px",height:"20px",cursor:"pointer"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:n?"#1976d2":"#666"}},n?"Single Click Segmentation":"Enable Single Click Segmentation")),n&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Single click segmentation is enabled. Clicking on the modal will auto-generate segmentation.")),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:q,disabled:n||a.length===0||d,style:{padding:"8px 16px",backgroundColor:!n&&a.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!n&&a.length>0?"pointer":"not-allowed",fontWeight:"bold"}},"Save as Keypoints (",a.length,")"),React.createElement("button",{onClick:$,disabled:n||a.length===0,style:{padding:"8px 16px",backgroundColor:!n&&!d||a.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!n&&!d&&a.length>0?"pointer":"not-allowed"}},"Clear Clicks (",a.length,")")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Promptable segmentation model from FiftyOne model zoo"),React.createElement("input",{type:"text",value:h,onChange:e=>T(e.target.value),placeholder:"e.g., segment-anything-2-hiera-small-image-torch",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:K,disabled:n||d,style:{padding:"8px 16px",backgroundColor:!n&&!d?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!n&&!d?"pointer":"not-allowed",fontWeight:"bold"}},"Segment with keypoints")))}r.registerComponent({name:"ClickSegmentation",label:"Click To Segment",component:P,type:r.PluginComponentType.Panel,activator:W,panelOptions:{surfaces:"modal"}});function W({dataset:t}){return!0}});
//# sourceMappingURL=index.umd.js.map
