(function(p,c){typeof exports=="object"&&typeof module<"u"?c(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("@fiftyone/state"),require("recoil"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","@fiftyone/state","recoil","react"],c):(p=typeof globalThis<"u"?globalThis:p||self,c(p.__fop__,p.__foo__,p.__fos__,p.recoil,p.React))})(this,function(p,c,B,D,l){"use strict";function I(o){const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const m in o)if(m!=="default"){const a=Object.getOwnPropertyDescriptor(o,m);Object.defineProperty(i,m,a.get?a:{enumerable:!0,get:()=>o[m]})}}return i.default=o,Object.freeze(i)}const X=I(B);function Y(){var A;const o=D.useRecoilValue(X.modalSample),[i,m]=l.useState([]),[a,K]=l.useState(!1),[f,O]=l.useState(!1),[N,T]=l.useState(!1),[s,W]=l.useState(!1),[n,k]=l.useState(!1),[g,P]=l.useState("user_clicks"),[b,M]=l.useState(""),[u,j]=l.useState("segment-anything-2-hiera-tiny-image-torch"),[R,q]=l.useState("label"),E=l.useRef([]);l.useEffect(()=>{if(!o)return;const e=o.sample.metadata;(!e||!e.width||!e.height)&&(console.log("Sample metadata not available. Computing metadata"),c.executeOperator("@51labs/click_segmentation/compute_metadata",{}).catch(r=>{console.error("Failed to compute metadata:",r)}))},[(A=o==null?void 0:o.sample)==null?void 0:A._id]),l.useEffect(()=>{if(!a||!o)return;const e=async r=>{const t=r.target;if(t.tagName!=="CANVAS")return;const d=t.getBoundingClientRect(),x=o.sample.metadata;if(!x||!x.width||!x.height){alert("Sample metadata not yet available. Reload/refresh the sample modal.");return}const v=x.width/x.height,Q=d.width/d.height;let y,h,C,_;v>Q?(y=d.width,h=d.width/v,C=0,_=(d.height-h)/2):(h=d.height,y=d.height*v,C=(d.width-y)/2,_=0);const U=r.clientX-d.left,Z=r.clientY-d.top,w=U-C,z=Z-_;if(w<0||w>y||z<0||z>h){console.log("Click outside image bounds");return}const ee=w/y,te=z/h,F={normalizedX:parseFloat(ee.toFixed(4)),normalizedY:parseFloat(te.toFixed(4)),label:s?0:1};console.log("Click captured:",F),G(r.clientX,r.clientY),n?await V(F):m(ae=>[...ae,F])};return document.addEventListener("click",e,!0),()=>document.removeEventListener("click",e,!0)},[a,o,n,s,u,g]);const L=async()=>{if(!g.trim()){alert("Please enter a field name");return}const e=i.map(t=>[t.normalizedX,t.normalizedY]),r=i.map(t=>[t.label]);try{await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:e,keypoint_labels:r,kpts_field_name:g.trim(),label_name:R.trim(),overwrite:!f}),await c.executeOperator("reload_dataset")}catch(t){console.error("Error saving keypoints:",t),alert(`Failed: ${t.message}`)}finally{S(),f||await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:u.trim(),label_field:b.trim(),overwrite:!1})}},V=async e=>{const r=[[e.normalizedX,e.normalizedY]];try{alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:r,kpts_field_name:g.trim(),label_name:R.trim(),overwrite:!0}),await new Promise(t=>setTimeout(t,10)),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:u.trim(),label_field:b.trim(),overwrite:!1}),m([])}catch(t){console.error("Error auto segmenting:",t),alert(`Failed: ${t.message}`)}finally{S()}},H=async()=>{try{n||alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:u.trim(),label_field:b.trim(),overwrite:!!N})}catch(e){console.error("Error saving keypoints:",e),alert(`Failed: ${e.message}`)}},G=(e,r)=>{const t=document.createElement("div");t.className="click-marker",t.style.position="fixed",t.style.left=`${e}px`,t.style.top=`${r}px`,t.style.width="12px",t.style.height="12px",t.style.borderRadius="50%",t.style.backgroundColor=s?"#1da10e":"#ff4444",t.style.border="3px solid white",t.style.transform="translate(-50%, -50%)",t.style.pointerEvents="none",t.style.zIndex="99999",t.style.boxShadow=s?"0 0 10px rgba(29,161,14,0.8)":"0 0 10px rgba(255,0,0,0.8)",document.body.appendChild(t),E.current.push(t)},J=()=>{E.current.forEach(e=>{e.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0)",setTimeout(()=>{e.remove()},300)}),E.current=[]},S=()=>{console.log("Clearing clicks and markers"),m([]),J()};return React.createElement("div",{style:{padding:"20px",display:"flex",flexDirection:"column",height:"100%"}},React.createElement("div",{style:{marginBottom:"15px"}},React.createElement("h3",{style:{margin:0}},"Image segmentation via point prompts")),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:a?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${a?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:a,onChange:e=>K(e.target.checked),style:{width:"20px",height:"20px",cursor:"pointer"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:a?"#1976d2":"#666"}},a?"Capturing Clicks":"Activate Click Capture")),a&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Click anywhere on the modal image to capture points.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving clicks (as keypoints)"),React.createElement("input",{type:"text",value:g,onChange:e=>P(e.target.value),placeholder:"e.g., user_clicks, keypoints",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Label name for the current set of clicks"),React.createElement("input",{type:"text",value:R,onChange:e=>q(e.target.value),placeholder:"e.g., animal, person",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:s?"#fdf0e3":"#f5f5f5",borderRadius:"8px",border:`2px solid ${s?"#f36b21":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:s,onChange:e=>{k(!1),W(e.target.checked)},disabled:!a,style:{width:"20px",height:"20px",cursor:a?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:s?"#d26319":"#666"}},s?"Negative Clicks Enabled":"Enable Negative Clicks")),a&&s&&React.createElement("p",{style:{fontSize:"12px",color:"#d26319",margin:"8px 0 0 30px",fontWeight:"500"}},"Capturing negative keypoint prompts via clicks. Not supported for single click execution.")),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:s?"#fdf0e3":"#f5f5f5",borderRadius:"8px",border:`2px solid ${s?"#f36b21":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:f,onChange:e=>{k(!1),O(e.target.checked)},disabled:!a,style:{width:"20px",height:"20px",cursor:a?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:f?"#d26319":"#666"}},f?"Append Mode Enabled":"Enable Append Mode")),a&&f&&React.createElement("p",{style:{fontSize:"12px",color:"#d26319",margin:"8px 0 0 30px",fontWeight:"500"}},"Active clicks will be appended to Keypoints sample field as a new set of clicks."),!f&&React.createElement("p",{style:{fontSize:"12px",color:"#666",margin:"8px 0 0 30px",fontWeight:"500"}},"When not appending, active clicks overwrite any existing Keypoints in the sample field and segmentation is auto-triggered.")),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:L,disabled:n||i.length===0,style:{padding:"8px 16px",backgroundColor:!n&&i.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!n&&i.length>0?"pointer":"not-allowed",fontWeight:"bold"}},"Save as Keypoints (",i.length,")"),React.createElement("button",{onClick:S,disabled:n||i.length===0,style:{padding:"8px 16px",backgroundColor:!n||i.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!n&&i.length>0?"pointer":"not-allowed"}},"Clear Clicks (",i.length,")")),React.createElement("hr",{style:{border:"none",borderTop:"1px solid #ddd",margin:"20px 0"}}),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:n?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${n?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:n,onChange:e=>{k(e.target.checked),W(!1),O(!1)},disabled:!a,style:{width:"20px",height:"20px",cursor:a?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:n?"#1976d2":"#666"}},n?"Single Click Segmentation":"Enable Single Click Segmentation")),n&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Single click segmentation is enabled. Clicking on the modal will auto-generate segmentation.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Promptable segmentation model from FiftyOne model zoo"),React.createElement("input",{type:"text",value:u,onChange:e=>j(e.target.value),placeholder:"e.g., segment-anything-2-hiera-small-image-torch",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving segmentation masks (optional)"),React.createElement("input",{type:"text",value:b,onChange:e=>M(e.target.value),placeholder:"Defaults to keypoint_field_seg, e.g., user_clicks_seg",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:H,disabled:n,style:{padding:"8px 16px",backgroundColor:n?"#ccc":"#2196F3",color:"white",border:"none",borderRadius:"4px",cursor:n?"not-allowed":"pointer",fontWeight:"bold"}},"Segment with keypoints"),React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"5px",fontSize:"13px",whiteSpace:"nowrap",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:N,onChange:e=>T(e.target.checked),style:{cursor:"pointer"}}),"Overwrite segmentations on SegmentWithKeypoints")))}p.registerComponent({name:"ClickSegmentation",label:"Click To Segment",component:Y,type:p.PluginComponentType.Panel,activator:$,panelOptions:{surfaces:"modal"}});function $({dataset:o}){return!0}});
//# sourceMappingURL=index.umd.js.map
