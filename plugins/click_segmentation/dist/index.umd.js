(function(s,c){typeof exports=="object"&&typeof module<"u"?c(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("@fiftyone/state"),require("recoil"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","@fiftyone/state","recoil","react"],c):(s=typeof globalThis<"u"?globalThis:s||self,c(s.__fop__,s.__foo__,s.__fos__,s.recoil,s.React))})(this,function(s,c,O,B,r){"use strict";function W(o){const l=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const m in o)if(m!=="default"){const n=Object.getOwnPropertyDescriptor(o,m);Object.defineProperty(l,m,n.get?n:{enumerable:!0,get:()=>o[m]})}}return l.default=o,Object.freeze(l)}const X=W(O);function Y(){var N;const o=B.useRecoilValue(X.modalSample),[l,m]=r.useState([]),[n,I]=r.useState(!1),[p,F]=r.useState(!1),[a,D]=r.useState(!1),[f,T]=r.useState(!1),[g,$]=r.useState("user_clicks"),[b,q]=r.useState(""),[h,P]=r.useState("segment-anything-2-hiera-tiny-image-torch"),[k,j]=r.useState("label"),R=r.useRef([]);r.useEffect(()=>{if(!o)return;const e=o.sample.metadata;(!e||!e.width||!e.height)&&(console.log("Sample metadata not available. Computing metadata"),c.executeOperator("@51labs/click_segmentation/compute_metadata",{}).catch(i=>{console.error("Failed to compute metadata:",i)}))},[(N=o==null?void 0:o.sample)==null?void 0:N._id]),r.useEffect(()=>{if(!n||!o)return;const e=async i=>{const t=i.target;if(t.tagName!=="CANVAS")return;const d=t.getBoundingClientRect(),u=o.sample.metadata;if(!u||!u.width||!u.height){alert("Sample metadata not yet available. Reload/refresh the sample modal.");return}const E=u.width/u.height,H=d.width/d.height;let x,y,S,_;E>H?(x=d.width,y=d.width/E,S=0,_=(d.height-y)/2):(y=d.height,x=d.height*E,S=(d.width-x)/2,_=0);const G=i.clientX-d.left,J=i.clientY-d.top,v=G-S,w=J-_;if(v<0||v>x||w<0||w>y){console.log("Click outside image bounds");return}const Q=v/x,Z=w/y,z={normalizedX:parseFloat(Q.toFixed(4)),normalizedY:parseFloat(Z.toFixed(4)),label:p?0:1};console.log("Click captured:",z),U(i.clientX,i.clientY),a?await L(z):m(ee=>[...ee,z])};return document.addEventListener("click",e,!0),()=>document.removeEventListener("click",e,!0)},[n,o,a,p,h,g,f]);const K=async()=>{if(!g.trim()){alert("Please enter a field name");return}const e=l.map(t=>[t.normalizedX,t.normalizedY]),i=l.map(t=>[t.label]);try{await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:e,keypoint_labels:i,kpts_field_name:g.trim(),label_name:k.trim()}),await c.executeOperator("reload_dataset")}catch(t){console.error("Error saving keypoints:",t),alert(`Failed: ${t.message}`)}finally{C()}},L=async e=>{const i=[[e.normalizedX,e.normalizedY]];try{alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:i,kpts_field_name:g.trim(),label_name:k.trim()}),console.log("Delegation ",f),await new Promise(t=>setTimeout(t,10)),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:h.trim(),label_field:b.trim()},{requestDelegation:f}),m([])}catch(t){console.error("Error auto segmenting:",t),alert(`Failed: ${t.message}`)}finally{C()}},M=async()=>{try{a||alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:h.trim(),label_field:b.trim()},{requestDelegation:f})}catch(e){console.error("Error saving keypoints:",e),alert(`Failed: ${e.message}`)}},U=(e,i)=>{const t=document.createElement("div");t.className="click-marker",t.style.position="fixed",t.style.left=`${e}px`,t.style.top=`${i}px`,t.style.width="12px",t.style.height="12px",t.style.borderRadius="50%",t.style.backgroundColor=p?"#1da10e":"#ff4444",t.style.border="3px solid white",t.style.transform="translate(-50%, -50%)",t.style.pointerEvents="none",t.style.zIndex="99999",t.style.boxShadow=p?"0 0 10px rgba(29,161,14,0.8)":"0 0 10px rgba(255,0,0,0.8)",document.body.appendChild(t),R.current.push(t)},V=()=>{R.current.forEach(e=>{e.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0)",setTimeout(()=>{e.remove()},300)}),R.current=[]},C=()=>{console.log("Clearing clicks and markers"),m([]),V()};return React.createElement("div",{style:{padding:"20px",display:"flex",flexDirection:"column",height:"100%"}},React.createElement("div",{style:{marginBottom:"15px"}},React.createElement("h3",{style:{margin:0}},"Image segmentation via point prompts")),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:n?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${n?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:n,onChange:e=>I(e.target.checked),style:{width:"20px",height:"20px",cursor:"pointer"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:n?"#1976d2":"#666"}},n?"Capturing Clicks":"Activate Click Capture")),n&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Click anywhere on the modal image to capture keypoints.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving clicks (as keypoints)"),React.createElement("input",{type:"text",value:g,onChange:e=>$(e.target.value),placeholder:"e.g., user_clicks, keypoints",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Label name for the current set of clicks"),React.createElement("input",{type:"text",value:k,onChange:e=>j(e.target.value),placeholder:"e.g., animal, person",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:p?"#fdf0e3":"#f5f5f5",borderRadius:"8px",border:`2px solid ${p?"#f36b21":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:p,onChange:e=>{D(!1),F(e.target.checked)},disabled:!n,style:{width:"20px",height:"20px",cursor:n?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:p?"#d26319":"#666"}},p?"Negative Clicks Enabled":"Enable Negative Clicks")),n&&p&&React.createElement("p",{style:{fontSize:"12px",color:"#d26319",margin:"8px 0 0 30px",fontWeight:"500"}},"Capturing negative keypoint prompts via clicks. Not supported for single click execution.")),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:K,disabled:a||l.length===0,style:{padding:"8px 16px",backgroundColor:!a&&l.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!a&&l.length>0?"pointer":"not-allowed",fontWeight:"bold"}},"Save as Keypoints (",l.length,")"),React.createElement("button",{onClick:C,disabled:a||l.length===0,style:{padding:"8px 16px",backgroundColor:!a||l.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!a&&l.length>0?"pointer":"not-allowed"}},"Clear Clicks (",l.length,")")),React.createElement("hr",{style:{border:"none",borderTop:"1px solid #ddd",margin:"20px 0"}}),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:a?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${a?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:a,onChange:e=>{D(e.target.checked),F(!1)},disabled:!n,style:{width:"20px",height:"20px",cursor:n?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:a?"#1976d2":"#666"}},a?"Single Click Segmentation":"Enable Single Click Segmentation")),a&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Single click segmentation is enabled. Clicking on the modal will auto-generate segmentation.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Promptable segmentation model from FiftyOne model zoo"),React.createElement("input",{type:"text",value:h,onChange:e=>P(e.target.value),placeholder:"e.g., segment-anything-2-hiera-small-image-torch",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving segmentation masks (optional)"),React.createElement("input",{type:"text",value:b,onChange:e=>q(e.target.value),placeholder:"Defaults to keypoint_field_seg, e.g., user_clicks_seg",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:M,disabled:a,style:{padding:"8px 16px",backgroundColor:a?"#ccc":"#2196F3",color:"white",border:"none",borderRadius:"4px",cursor:a?"not-allowed":"pointer",fontWeight:"bold"}},"Segment with keypoints"),React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"5px",fontSize:"13px",whiteSpace:"nowrap",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:f,onChange:e=>T(e.target.checked),style:{cursor:"pointer"}}),"Use Delegated Operation")))}s.registerComponent({name:"ClickSegmentation",label:"Click To Segment",component:Y,type:s.PluginComponentType.Panel,activator:A,panelOptions:{surfaces:"modal"}});function A({dataset:o}){return!0}});
//# sourceMappingURL=index.umd.js.map
