(function(s,c){typeof exports=="object"&&typeof module<"u"?c(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("@fiftyone/state"),require("recoil"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","@fiftyone/state","recoil","react"],c):(s=typeof globalThis<"u"?globalThis:s||self,c(s.__fop__,s.__foo__,s.__fos__,s.recoil,s.React))})(this,function(s,c,O,B,r){"use strict";function D(o){const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const m in o)if(m!=="default"){const n=Object.getOwnPropertyDescriptor(o,m);Object.defineProperty(i,m,n.get?n:{enumerable:!0,get:()=>o[m]})}}return i.default=o,Object.freeze(i)}const W=D(O);function X(){var N;const o=B.useRecoilValue(W.modalSample),[i,m]=r.useState([]),[n,A]=r.useState(!1),[d,z]=r.useState(!1),[a,F]=r.useState(!1),[g,T]=r.useState("user_clicks"),[h,$]=r.useState(""),[y,I]=r.useState("segment-anything-2-hiera-tiny-image-torch"),[b,P]=r.useState("label"),k=r.useRef([]);r.useEffect(()=>{if(!o)return;const e=o.sample.metadata;(!e||!e.width||!e.height)&&(console.log("Sample metadata not available. Computing metadata"),c.executeOperator("@51labs/click_segmentation/compute_metadata",{}).catch(l=>{console.error("Failed to compute metadata:",l)}))},[(N=o==null?void 0:o.sample)==null?void 0:N._id]),r.useEffect(()=>{if(!n||!o)return;const e=async l=>{const t=l.target;if(t.tagName!=="CANVAS")return;const p=t.getBoundingClientRect(),f=o.sample.metadata;if(!f||!f.width||!f.height){alert("Sample metadata not yet available. Reload/refresh the sample modal.");return}const C=f.width/f.height,V=p.width/p.height;let u,x,E,S;C>V?(u=p.width,x=p.width/C,E=0,S=(p.height-x)/2):(x=p.height,u=p.height*C,E=(p.width-u)/2,S=0);const H=l.clientX-p.left,G=l.clientY-p.top,_=H-E,v=G-S;if(_<0||_>u||v<0||v>x){console.log("Click outside image bounds");return}const J=_/u,Q=v/x,w={normalizedX:parseFloat(J.toFixed(4)),normalizedY:parseFloat(Q.toFixed(4)),label:d?0:1};console.log("Click captured:",w),L(l.clientX,l.clientY),a?await q(w):m(U=>[...U,w])};return document.addEventListener("click",e,!0),()=>document.removeEventListener("click",e,!0)},[n,o,a,d,y,g]);const j=async()=>{if(!g.trim()){alert("Please enter a field name");return}const e=i.map(t=>[t.normalizedX,t.normalizedY]),l=i.map(t=>[t.label]);try{await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:e,keypoint_labels:l,kpts_field_name:g.trim(),label_name:b.trim()}),await c.executeOperator("reload_dataset")}catch(t){console.error("Error saving keypoints:",t),alert(`Failed: ${t.message}`)}finally{R()}},q=async e=>{const l=[[e.normalizedX,e.normalizedY]];try{alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/save_keypoints",{keypoints:l,kpts_field_name:g.trim(),label_name:b.trim()}),await new Promise(t=>setTimeout(t,10)),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:y.trim(),label_field:h.trim()}),m([])}catch(t){console.error("Error auto segmenting:",t),alert(`Failed: ${t.message}`)}finally{R()}},K=async()=>{try{a||alert("Segmentation in progress"),await c.executeOperator("@51labs/click_segmentation/segment_with_prompts",{prompt_field:g.trim(),model_name:y.trim(),label_field:h.trim()})}catch(e){console.error("Error saving keypoints:",e),alert(`Failed: ${e.message}`)}},L=(e,l)=>{const t=document.createElement("div");t.className="click-marker",t.style.position="fixed",t.style.left=`${e}px`,t.style.top=`${l}px`,t.style.width="12px",t.style.height="12px",t.style.borderRadius="50%",t.style.backgroundColor=d?"#1da10e":"#ff4444",t.style.border="3px solid white",t.style.transform="translate(-50%, -50%)",t.style.pointerEvents="none",t.style.zIndex="99999",t.style.boxShadow="0 0 10px rgba(255,0,0,0.8)",document.body.appendChild(t),k.current.push(t)},M=()=>{k.current.forEach(e=>{e.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0)",setTimeout(()=>{e.remove()},300)}),k.current=[]},R=()=>{console.log("Clearing clicks and markers"),m([]),M()};return React.createElement("div",{style:{padding:"20px",display:"flex",flexDirection:"column",height:"100%"}},React.createElement("div",{style:{marginBottom:"15px"}},React.createElement("h3",{style:{margin:0}},"Image segmentation via point prompts")),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:n?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${n?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:n,onChange:e=>A(e.target.checked),style:{width:"20px",height:"20px",cursor:"pointer"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:n?"#1976d2":"#666"}},n?"Capturing Clicks":"Activate Click Capture")),n&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Click anywhere on the modal image to capture keypoints.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving clicks (as keypoints)"),React.createElement("input",{type:"text",value:g,onChange:e=>T(e.target.value),placeholder:"e.g., user_clicks, keypoints",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Label name for the current set of clicks"),React.createElement("input",{type:"text",value:b,onChange:e=>P(e.target.value),placeholder:"e.g., animal, person",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:d?"#fdf0e3":"#f5f5f5",borderRadius:"8px",border:`2px solid ${d?"#f36b21":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:d,onChange:e=>{F(!1),z(e.target.checked)},disabled:!n,style:{width:"20px",height:"20px",cursor:n?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:d?"#d26319":"#666"}},d?"Negative Clicks Enabled":"Enable Negative Clicks")),n&&d&&React.createElement("p",{style:{fontSize:"12px",color:"#d26319",margin:"8px 0 0 30px",fontWeight:"500"}},"Capturing negative keypoint prompts via clicks. Not supported for single click execution.")),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:j,disabled:a||i.length===0,style:{padding:"8px 16px",backgroundColor:!a&&i.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!a&&i.length>0?"pointer":"not-allowed",fontWeight:"bold"}},"Save as Keypoints (",i.length,")"),React.createElement("button",{onClick:R,disabled:a||i.length===0,style:{padding:"8px 16px",backgroundColor:!a||i.length>0?"#2196F3":"#ccc",color:"white",border:"none",borderRadius:"4px",cursor:!a&&i.length>0?"pointer":"not-allowed"}},"Clear Clicks (",i.length,")")),React.createElement("hr",{style:{border:"none",borderTop:"1px solid #ddd",margin:"20px 0"}}),React.createElement("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",padding:"15px",backgroundColor:a?"#e3f2fd":"#f5f5f5",borderRadius:"8px",border:`2px solid ${a?"#2196F3":"#ddd"}`,transition:"all 0.3s ease"}},React.createElement("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer"}},React.createElement("input",{type:"checkbox",checked:a,onChange:e=>{F(e.target.checked),z(!1)},disabled:!n,style:{width:"20px",height:"20px",cursor:n?"pointer":"not-allowed"}}),React.createElement("span",{style:{fontWeight:"bold",fontSize:"15px",color:a?"#1976d2":"#666"}},a?"Single Click Segmentation":"Enable Single Click Segmentation")),a&&React.createElement("p",{style:{fontSize:"12px",color:"#1976d2",margin:"8px 0 0 30px",fontWeight:"500"}},"Single click segmentation is enabled. Clicking on the modal will auto-generate segmentation.")),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Promptable segmentation model from FiftyOne model zoo"),React.createElement("input",{type:"text",value:y,onChange:e=>I(e.target.value),placeholder:"e.g., segment-anything-2-hiera-small-image-torch",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"8px",padding:"4px"}},React.createElement("label",{style:{display:"flex",flexDirection:"column",gap:"8px",fontSize:"14px"}},React.createElement("span",{style:{fontSize:"14px",color:"#666"}},"Sample field name for saving segmentation masks (optional)"),React.createElement("input",{type:"text",value:h,onChange:e=>$(e.target.value),placeholder:"Defaults to keypoint_field_seg, e.g., user_clicks_seg",style:{padding:"8px 12px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px",fontFamily:"monospace"}}))),React.createElement("div",{style:{marginBottom:"10px",display:"flex",gap:"10px"}},React.createElement("button",{onClick:K,disabled:a,style:{padding:"8px 16px",backgroundColor:a?"#ccc":"#2196F3",color:"white",border:"none",borderRadius:"4px",cursor:a?"not-allowed":"pointer",fontWeight:"bold"}},"Segment with keypoints")))}s.registerComponent({name:"ClickSegmentation",label:"Click To Segment",component:X,type:s.PluginComponentType.Panel,activator:Y,panelOptions:{surfaces:"modal"}});function Y({dataset:o}){return!0}});
//# sourceMappingURL=index.umd.js.map
